{
	"name": "2 HealthCare SQL Pool Security RLS",
	"properties": {
		"folder": {
			"name": "hpi_sql_pool/analysis"
		},
		"content": {
			"query": "/******Important – Do not use in production, for demonstration purposes only – please review the legal notices by clicking the following link****/\n---DisclaimerLink:  https://healthcaredemoapp.azurewebsites.net/#/disclaimer\n---License agreement: https://github.com/microsoft/Azure-Analytics-and-AI-Engagement/blob/main/HealthCare/License.md\n\n/* **DISCLAIMER**\nBy accessing this code, you acknowledge the code is made available for presentation and demonstration purposes only and that the code: (1) is not subject to SOC 1 and SOC 2 compliance audits; (2) is not designed or intended to be a substitute for the professional advice, diagnosis, treatment, or judgment of a certified financial services professional; (3) is not designed, intended or made available as a medical device; and (4) is not designed or intended to be a substitute for professional medical advice, diagnosis, treatment or judgement. Do not use this code to replace, substitute, or provide professional financial advice or judgment, or to replace, substitute or provide medical advice, diagnosis, treatment or judgement. You are solely responsible for ensuring the regulatory, legal, and/or contractual compliance of any use of the code, including obtaining any authorizations or consents, and any solution you choose to build that incorporates this code in whole or in part. */\n\n/*\tRow level Security (RLS) in Azure Synapse enables us to use group membership to control access to rows in a table.\n\tAzure Synapse applies the access restriction every time the data access is attempted from any user. \n\tLet see how we can implement row level security in Azure Synapse.*/\n\n----------------------------------Row-Level Security (RLS), 1: Filter predicates------------------------------------------------------------------\n-- Step:1 The [HealthCare-FactSales] table has two Analyst values i.e. CareManagerMiami and CareManagerLosAngeles\nSELECT top 100 * FROM hpi.[HealthCare-FactSales] order by City ;\n\n/* Moving ahead, we Create a new schema, and an inline table-valued function. \nThe function returns 1 when a row in the Analyst column is the same as the user executing the query (@Analyst = USER_NAME())\n or if the user executing the query is the ChiefOperatingManager user (USER_NAME() = 'ChiefOperatingManager').\n*/\n\n--Step:2 To set up RLS, the following query creates three login users :  ChiefOperatingManager, CareManagerMiami, CareManagerLosAngeles\nExec hpi.Sp_HealthCareRLS\nGO\nCREATE SCHEMA Security\nGO\nCREATE FUNCTION Security.fn_securitypredicate(@Analyst AS sysname)  \n    RETURNS TABLE  \nWITH SCHEMABINDING  \nAS  \n    RETURN SELECT 1 AS fn_securitypredicate_result\nWHERE @Analyst = USER_NAME() OR USER_NAME() = 'ChiefOperatingManager'\nGO\n-- Now we define security policy that allows users to filter rows based on thier login name.\nCREATE SECURITY POLICY SalesFilter  \nADD FILTER PREDICATE Security.fn_securitypredicate(CareManager)\nON hpi.[HealthCare-FactSales]\nWITH (STATE = ON);\n------ Allow SELECT permissions to the fn_securitypredicate function.------\nGRANT SELECT ON security.fn_securitypredicate TO ChiefOperatingManager, CareManagerMiami, CareManagerLosAngeles;\n\n\n-- Step:3 Let us now test the filtering predicate, by selecting data from the [HealthCare-FactSales] table as 'CareManagerMiami' user.\nEXECUTE AS USER = 'CareManagerMiami'; \nSELECT * FROM hpi.[HealthCare-FactSales];\nrevert;\n-- As we can see, the query has returned rows here Login name is CareManagerMiami\n\n-- Step:4 Let us test the same for  'CareManagerLosAngeles' user.\nEXECUTE AS USER = 'CareManagerLosAngeles'; \nSELECT * FROM [HealthCare-FactSales];\nrevert;\n-- RLS is working indeed.\n\n-- Step:5 The ChiefOperatingManager should be able to see all rows in the table.\nEXECUTE AS USER = 'ChiefOperatingManager';  \nSELECT * FROM [HealthCare-FactSales];\nrevert;\n-- And he can.\n\n--Step:6 To disable the security policy we just created above, we execute the following.\nALTER SECURITY POLICY SalesFilter  \nWITH (STATE = OFF);\n\nDROP SECURITY POLICY SalesFilter;\nDROP FUNCTION Security.fn_securitypredicate;\nDROP SCHEMA Security;",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "syndpdev00006",
				"poolName": "syndpdev00006"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}